#include <stdio.h>
#include <stdlib.h>
#include <sys/stat.h>
#include <nds.h>
#include <nds/registers_alt.h>

#include "../../../../arm7/ipcz.h"

#include "_console.h"

#include "dldi.h"

#define _VRAM_OFFSET(n) ((n)<<3)
#define _VRAM_PTR ((u16*)0x06000000)
#define _VRAM_CD_MAIN_BG_0x6000000 (1 | _VRAM_OFFSET(0))
#define _VRAM_CD_MAIN_BG_0x6020000 (1 | _VRAM_OFFSET(1))
#define _VRAM_CD_ARM7_0x6000000 (2 | _VRAM_OFFSET(0))
#define _VRAM_CD_ARM7_0x6020000 (2 | _VRAM_OFFSET(1))

const unsigned char ndshead[512]={
  0x2e,0x00,0x00,0xea,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x23,0x23,0x23,0x23,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,
  0x00,0x02,0x00,0x00,0x00,0x00,0x38,0x02,0x00,0x00,0x38,0x02,0x00,0xa0,0x00,0x00,
  0x00,0xa2,0x00,0x00,0x00,0xd8,0x3a,0x02,0x00,0xd8,0x3a,0x02,0x00,0x19,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0xff,0x7f,0x7f,0x00,0xff,0x1f,0x3f,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x1e,0x05,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0xbe,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x53,0x52,0x41,0x4d,0x5f,0x56,0x31,0x31,0x30,0x00,0x00,0x00,0x50,0x41,0x53,0x53,
  0x30,0x31,0x96,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0xc8,0x60,0x4f,0xe2,0x01,0x70,0x8f,0xe2,0x17,0xff,0x2f,0xe1,0x12,0x4f,0x11,0x48,
  0x12,0x4c,0x20,0x60,0x64,0x60,0x7c,0x62,0x30,0x1c,0x39,0x1c,0x10,0x4a,0x00,0xf0,
  0x14,0xf8,0x30,0x6a,0x80,0x19,0xb1,0x6a,0xf2,0x6a,0x00,0xf0,0x0b,0xf8,0x30,0x6b,
  0x80,0x19,0xb1,0x6b,0xf2,0x6b,0x00,0xf0,0x08,0xf8,0x70,0x6a,0x77,0x6b,0x07,0x4c,
  0x60,0x60,0x38,0x47,0x07,0x4b,0xd2,0x18,0x9a,0x43,0x07,0x4b,0x92,0x08,0xd2,0x18,
  0x0c,0xdf,0xf7,0x46,0x04,0xf0,0x1f,0xe5,0x00,0xfe,0x7f,0x02,0xf0,0xff,0x7f,0x02,
  0xf0,0x01,0x00,0x00,0xff,0x01,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

static inline void _dmaFillWords(const void* src, void* dest, uint32 size) {
	DMA_SRC(3)  = (uint32)src;
	DMA_DEST(3) = (uint32)dest;
	DMA_CR(3)   = DMA_COPY_WORDS | DMA_SRC_FIX | (size>>2);
	while(DMA_CR(3) & DMA_BUSY);
}

static void __attribute__ ((long_call)) resetMemory1_ARM9 (void) 
{
	REG_IME = 0;
	REG_IE = 0;
	REG_IF = ~0;

	(*(vu32*)0x00803FFC) = 0;   //IRQ_HANDLER ARM9 version
	(*(vu32*)0x00803FF8) = ~0;  //VBLANK_INTR_WAIT_FLAGS ARM9 version
}

static void __attribute__ ((long_call)) (*lp_resetMemory1_ARM9) (void) =resetMemory1_ARM9;

static void __attribute__ ((long_call)) resetMemory2_ARM9 (void) 
{
 	register int i;
  
	//clear out ARM9 DMA channels
	for (i=0; i<4; i++) {
		DMA_CR(i) = 0;
		DMA_SRC(i) = 0;
		DMA_DEST(i) = 0;
		TIMER_CR(i) = 0;
		TIMER_DATA(i) = 0;
	}

	VRAM_CR = 0x80808080;
	(*(vu32*)0x027FFE04) = 0;   // temporary variable
	BG_PALETTE[0] = 0xFFFF;
	_dmaFillWords((void*)0x027FFE04, BG_PALETTE+1, (2*1024)-2);
	_dmaFillWords((void*)0x027FFE04, OAM,     2*1024);
	_dmaFillWords((void*)0x027FFE04, (void*)0x04000000, 0x56);  //clear main display registers
	_dmaFillWords((void*)0x027FFE04, (void*)0x04001000, 0x56);  //clear sub  display registers
	_dmaFillWords((void*)0x027FFE04, VRAM,  656*1024);
	
	REG_DISPSTAT=0;
	videoSetMode(0);
	videoSetModeSub(0);
	VRAM_A_CR = 0;
	VRAM_B_CR = 0;
	VRAM_C_CR = 0;
	VRAM_D_CR = 0;
	VRAM_E_CR = 0;
	VRAM_F_CR = 0;
	VRAM_G_CR = 0;
	VRAM_H_CR = 0;
	VRAM_I_CR = 0;
	VRAM_CR   = 0x03000000;
	POWER_CR  = 0x820F;

	//set shared ram to ARM7
	WRAM_CR = 0x03;
}

static void __attribute__ ((long_call)) (*lp_resetMemory2_ARM9) (void) =resetMemory2_ARM9;


static void bootMoonlight(u32 BootAddress)
{
  REG_IME = IME_DISABLE;	// Disable interrupts
  REG_IF = REG_IF;	// Acknowledge interrupt
  
  IPCZ->bootaddress=0;
  IPCZ->cmd=ResetMoonlight;
  
  VRAM_C_CR = VRAM_ENABLE | _VRAM_CD_MAIN_BG_0x6000000;
  VRAM_D_CR = VRAM_ENABLE | _VRAM_CD_MAIN_BG_0x6020000;

  DC_FlushAll();
  
  _consolePrint("resetMemory1_ARM9\n");
  lp_resetMemory1_ARM9();
  _consolePrint("resetMemory2_ARM9\n");
  lp_resetMemory2_ARM9();
  
  _consolePrintf("Reset to 0x%08x\n",BootAddress);
  
  VRAM_C_CR = VRAM_ENABLE | _VRAM_CD_ARM7_0x6000000;
  VRAM_D_CR = VRAM_ENABLE | _VRAM_CD_ARM7_0x6020000;
  *((vu32*)0x027FFE04) = (u32)0xE59FF018;  // ldr pc, 0x027FFE24
  *((vu32*)0x027FFE24) = (u32)0x027FFE04;  // Set ARM9 Loop address
  IPCZ->bootaddress=BootAddress;
  swiSoftReset();  // Reset
  _consolePrintf("Failed.\n");
  die();
}

unsigned int read32(const void *p);
void write32(void *p, const unsigned int n); //dldi.c

void BootDSBooter(const char *pFilename){
  struct stat st;
  u32 FileSize;
  u8 *pFileBuf;
  u8 head[512],dec[512];

  u8 *pA=NULL,*p7=NULL,*p9=NULL;
  u32 l7,l9,a7,a9,pad7,pad9;

  FILE *FileHandle=fopen(pFilename,"rb");
  fread(head,1,512,FileHandle);
  
  if(FileHandle==NULL)
    {_consolePrintf("Can not open NDS file %s.\n",pFilename);die();}

  fstat(fileno(FileHandle),&st);
  FileSize=st.st_size;
  
  if(FileSize==0)
    {_consolePrintf("Can not open NDS file %s.\n",pFilename);die();}

  _consolePrintf("MainRam loader X with m3make preparing.\n");

  //building header...
  _consolePrintf("Decrypting... ");
	{
		int i=0,j;
		for(;i<0x100;i++){
			for(j=0xa0;j<0xa8;j++)
				dec[j]=head[j]^i;
			if(!memcmp(dec+0xa0,"DSBooter",8))
				{_consolePrintf("key = 0x%02x\n",i);break;}
		}
		if(i==0x100){printf("Cannot decode or not DSBooter\n");die();}
		for(j=0x000;j<0x200;j++)
			head[j]=head[j]^i;
	}
  pA=head+0xc8;
  _consolePrintf("p9=0x%08x\n",(p9=pA+read32(pA+0x00))-head);
  _consolePrintf("l9=0x%08x\n",l9=read32(pA+0x08));
  _consolePrintf("a9=0x%08x\n",a9=read32(pA+0x04));
  _consolePrintf("p7=0x%08x\n",(p7=pA+read32(pA+0x0c)+0x0c)-head);
  _consolePrintf("l7=0x%08x\n",l7=read32(pA+0x14));
  _consolePrintf("a7=0x%08x\n",a7=read32(pA+0x10));
  pad9=0x100-(l9&0xff);
  pad7=0x100-(l7&0xff);

  //writing loader to memory...
  pFileBuf=(u8*)(0x02000000+2*1024*1024);
  memcpy(pFileBuf,ndshead,512);
  write32(pFileBuf+0x24,a9);
  write32(pFileBuf+0x28,a9);
  write32(pFileBuf+0x2c,l9/*+pad9*/);
  write32(pFileBuf+0x30,l9+pad9+0x200);
  write32(pFileBuf+0x34,a7);
  write32(pFileBuf+0x38,a7);
  write32(pFileBuf+0x3c,l7/*+pad7*/);
  write32(pFileBuf+0x80,0x200+l9+pad9+l7+pad7);
  fseek(FileHandle,p9-head,SEEK_SET);
  fread(pFileBuf+0x200,1,l9,FileHandle);
  fseek(FileHandle,p7-head,SEEK_SET);
  fread(pFileBuf+0x200+l9+pad9,1,l7,FileHandle);
  fclose(FileHandle);

  //FileHandle=fopen("/loader.bin","wb");
  //fwrite(pFileBuf,1,0x200+l9+pad9+l7+pad7,FileHandle);
  //fclose(FileHandle);
  
  _consolePrintf("Rebooting...\n");
  bootMoonlight((u32)pFileBuf);
}

void BootNDSROM(const char *pFilename){
  struct stat st;
  u32 FileSize;
  u8 *pFileBuf;
  FILE *FileHandle=fopen(pFilename,"rb");
  
  if(FileHandle==NULL)
    {_consolePrintf("Can not open NDS file %s.\n",pFilename);die();}

  fstat(fileno(FileHandle),&st);
  FileSize=st.st_size;
  
  if(FileSize==0)
    {_consolePrintf("Can not open NDS file %s.\n",pFilename);die();}

  if(FileSize>0x001ff000){
    _consolePrintf("Filesize too big. Falling back to bootlib.\n",pFilename);
    fclose(FileHandle);runNdsFile(pFilename);
  }

  _consolePrintf("MainRam loader X preparing.\n");
  _consolePrintf("Trying to load file\n");

  //pFileBuf=(u8*)malloc(FileSize+3);
  pFileBuf=(u8*)(0x02000000+2*1024*1024);
//  if(pFileBuf){
    fread(pFileBuf,1,FileSize+3,FileHandle);
    fclose(FileHandle);
    _consolePrintf("Applying DLDI...\n");
    dldi(pFileBuf,FileSize);
    _consolePrintf("Rebooting...\n");
    bootMoonlight((u32)pFileBuf);
//  }

//fail:
//  _consolePrintf("Cannot allocate %dbytes\n",FileSize+3);
//  while(1)swiWaitForVBlank();
}
